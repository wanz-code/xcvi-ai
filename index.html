<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>XCVI - AI ‚Ä¢ XCViienzo</title>
<style>
:root{
  --bg:#040407;
  --panel:#0f1115;
  --muted:#9aa3b2;
  --text:#e9eef8;
  --accent:#8b5cf6;
  --accent2:#1dd1a1;
  --border:#20202a;
  --glass: rgba(255,255,255,0.02);
  --notif-bg: rgba(20,20,22,0.96);
  --card-radius:14px;
  --ease: cubic-bezier(.2,.9,.3,1);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased}
body{display:flex;flex-direction:column;min-height:100vh}

/* ---------- Topbar (solid, no glass) ---------- */
.topbar {
  height:56px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:8px 14px;
  border-bottom:1px solid rgba(255,255,255,0.06);
  position:sticky;
  top:0;
  background:var(--panel);   /* solid, tidak transparan */
  z-index:700;               /* di atas semua elemen lain */
}
.top-left{display:flex;align-items:center;gap:12px}
.burger{
  width:42px;height:42px;border-radius:10px;display:flex;flex-direction:column;
  justify-content:center;gap:5px;align-items:center;cursor:pointer;background:transparent;border:1px solid transparent;
  transition:transform .18s var(--ease);
}
.burger:active{transform:scale(.98)}
.burger .bar{
  width:20px;height:2.8px;background:var(--text);border-radius:2px;transition:all .18s var(--ease);
}
.brand{display:flex;align-items:center;gap:10px;font-weight:700}
.brand img{width:34px;height:34px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,0.03)}
.status{font-size:13px;color:var(--muted)}

/* Layout */
.container{display:flex;flex:1;width:100%;gap:0;margin:0;padding:0;position:relative;overflow:hidden}

/* Sidebar */
.sidebar{
  position:fixed;
  top:56px; /* mulai tepat di bawah topbar -> menghindari bentrok teks/brand */
  left:0;
  height:calc(100vh - 56px);
  width:300px;
  max-width:88%;
  padding:18px;
  background:var(--panel);   /* solid background, tidak transparan */
  border-right:1px solid var(--border);
  box-shadow:6px 0 40px rgba(0,0,0,.6);
  transform:translateX(-100%);            /* awal: tersembunyi di kiri */
  transition:transform .36s cubic-bezier(.2,.9,.25,1), opacity .28s;
  z-index:650;                             /* di bawah topbar, di atas overlay */
  border-radius:0 18px 18px 0;
  -webkit-font-smoothing:antialiased;
  color:var(--text);                       /* teks jelas */
}
.sidebar.show{
  transform:translateX(0);                /* slide-in full */
}
.sidebar h3 { color: var(--text); margin:0 0 8px 0; }
.sidebar .muted { color: var(--muted); font-size:13px; margin-bottom:8px; }
.sidebar .btn {
  color:var(--text);
  background:transparent;
  border:1px solid rgba(255,255,255,0.04);
}
.btn{display:block;width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);text-align:left;cursor:pointer;margin-top:8px;font-size:14px}
.sidebar textarea{width:100%;min-height:80px;padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);resize:vertical;font-size:13px}

/* Contact card inside sidebar */
.contact-card { background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border:1px solid rgba(255,255,255,0.02); }
.contact-top{display:flex;align-items:center;gap:10px}
.contact-top img{width:48px;height:48px;border-radius:8px;object-fit:cover}
.contact-links{display:flex;gap:8px;margin-top:6px}
.contact-links a{flex:1;text-decoration:none;padding:8px;border-radius:8px;text-align:center;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#071018;font-weight:600;font-size:13px;display:inline-block}

/* Overlay */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  backdrop-filter:none;  /* no blur */
  z-index:600;           /* di bawah sidebar, di bawah topbar */
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease;
}
.overlay.show{
  opacity:1;
  pointer-events:auto;
}

/* Chat area full */
.chat-area{flex:1;display:flex;flex-direction:column;min-height:calc(100vh - 56px - 44px);overflow:hidden}
.chat-window{
  flex:1;padding:16px 18px 110px 18px;overflow-y:auto;display:flex;flex-direction:column;gap:12px;
  scroll-behavior:smooth;
}

/* Messages */
.msg{max-width:78%;padding:10px 14px;border-radius:12px;font-size:14px;line-height:1.45;display:flex;gap:10px;align-items:flex-start;animation:pop .18s var(--ease)}
@keyframes pop{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.msg.ai{align-self:flex-start;background:var(--glass);border:1px solid var(--border)}
.msg.user{align-self:flex-end;background:linear-gradient(135deg, rgba(139,92,246,.11), rgba(29,209,161,.03));border:1px solid rgba(139,92,246,.08)}
.msg .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
.msg img.avatar{width:34px;height:34px;border-radius:8px;object-fit:cover}
.empty-hint{color:var(--muted);text-align:center;padding:24px;font-size:13px}
/* Efek titik bergelombang bot typing */
.typing-dots span {
  animation: wave 1.2s infinite;
  display: inline-block;
  margin-right: 2px;
  font-weight: bold;
}
.typing-dots span:nth-child(1){ animation-delay:0s }
.typing-dots span:nth-child(2){ animation-delay:0.2s }
.typing-dots span:nth-child(3){ animation-delay:0.4s }

@keyframes wave {
  0%, 60%, 100% { transform: initial }
  30% { transform: translateY(-6px) } /* gelombang naik turun */
}

/* Composer sticky & minimal */
.composer-wrap{
  position:sticky;bottom:14px;border-top:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(0,0,0,0.00), rgba(0,0,0,0.02));padding:10px 14px;z-index:90;
  display:flex;align-items:center;justify-content:center;
}
.composer{display:flex;gap:10px;align-items:flex-end;width:100%;max-width:1100px;margin:0 auto}
textarea#input{
  flex:1;min-height:40px;max-height:160px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);
  background:#0b0c10;color:var(--text);font-size:14px;line-height:1.35;resize:none;outline:none;
  transition:box-shadow .12s var(--ease), transform .12s var(--ease);
}
textarea#input:focus{box-shadow:0 6px 30px rgba(0,0,0,.6);transform:translateY(-2px)}
.send-btn{width:48px;height:44px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#071018;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.attach-btn{width:44px;height:44px;border-radius:10px;border:1px solid var(--border);background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;margin-right:6px}

/* Attach popup (animated) */
.attach-popup{
  position:absolute;bottom:72px;left:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  padding:12px;border-radius:12px;border:1px solid var(--border);box-shadow:0 18px 50px rgba(0,0,0,.65);
  display:flex;flex-direction:column;gap:8px;min-width:220px;transform:translateY(12px);opacity:0;pointer-events:none;transition:all .22s var(--ease);z-index:220;
}
.attach-popup.show{transform:translateY(0);opacity:1;pointer-events:auto}
.attach-option{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;cursor:pointer;border:1px solid transparent;transition:all .14s var(--ease)}
.attach-option:hover{transform:translateY(-4px);box-shadow:0 8px 30px rgba(0,0,0,.5);border-color:rgba(255,255,255,0.02)}
.attach-option svg{width:20px;height:20px;flex-shrink:0}

/* Modal camera (center) */
/* Modal popup (laporan, kamera, dll) */
.popup{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.55); /* sedikit lebih gelap biar fokus */
  z-index:1200;                /* ‚úÖ paling atas, di atas sidebar & topbar */
  opacity:0;
  pointer-events:none;
  transition:opacity .18s;
}
.popup.show{opacity:1;pointer-events:auto}
.popup-card{width:min(720px,94%);background:var(--panel);padding:18px;border-radius:16px;border:1px solid var(--border);box-shadow:0 26px 80px rgba(0,0,0,.7)}

/* Notification (iPhone style) top center */
.notif-wrap {
  position:fixed;
  top:18px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000; /* ‚úÖ lebih tinggi dari topbar (700) dan sidebar (650) */
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:center;
  pointer-events:none;
}
.notif{
  min-width:260px;max-width:560px;padding:12px 16px;border-radius:16px;background:var(--notif-bg);backdrop-filter:blur(8px);color:var(--text);border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 10px 40px rgba(0,0,0,.6);opacity:0;transform:translateY(-8px) scale(.98);transition:all .28s var(--ease);pointer-events:auto;
}
.notif.show{opacity:1;transform:translateY(0) scale(1)}
.notif.success{border-left:4px solid #22c55e}
.notif.warn{border-left:4px solid #f97316}

/* footer watermark */
.wm{text-align:center;color:var(--muted);font-size:11px;padding:8px 0}

/* responsive tweaks */
@media(max-width:920px){
  .composer{padding:0 8px}
  .attach-popup{left:8px;min-width:200px}
}
</style>
</head>
<body>
  <!-- notification container (top-center) -->
  <div class="notif-wrap" id="notifWrap" aria-live="polite" aria-atomic="true"></div>

  <header class="topbar" role="banner">
    <div class="top-left">
      <button id="menuBtn" class="burger" aria-label="Menu" title="Menu">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
      </button>

      <div class="brand" aria-hidden="false">
        <img id="logoImg" src="https://files.catbox.moe/a8uk9h.jpg" alt="logo" />
        <div>XCVI - AI</div>
      </div>
    </div>

    <div class="status" id="statusDot">‚óè <span id="statusText">Checking...</span></div>
  </header>

  <div class="container">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar" aria-hidden="true">
      <h3>Pengaturan</h3>
      <div class="muted">Opsi</div>

      <button id="clearHistory" class="btn">üóë Hapus Riwayat</button>
      <button id="reportBtn" class="btn">‚ö†Ô∏è Laporkan</button>

      <label class="muted" style="margin-top:12px">Custom Prompt (opsional)</label>
      <textarea id="customPrompt" placeholder="Atur kepribadian Ai"></textarea>

      <div style="height:10px"></div>
      <div class="muted">Mode AI</div>
      <select id="roleSelect" style="padding:10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);margin-top:8px">
        <option value="">XCVI</option>
        <option value="asisten">Asisten</option>
        <option value="guru">Guru</option>
        <option value="gaming">Gaming</option>
        <option value="roleplay">Roleplay</option>
      </select>

      <!-- Contact -->
      <div class="contact-card" aria-hidden="false">
        <div class="contact-top">
          <img src="https://files.catbox.moe/a8uk9h.jpg" alt="Wanz logo">
          <div>
            <div style="font-weight:700">Wanz Official</div>
            <div style="font-size:12px;color:var(--muted)">Developer & Support</div>
          </div>
        </div>
        <div class="contact-links">
          <a href="https://wa.me/6283898206223" target="_blank" rel="noopener">WhatsApp</a>
          <a href="https://instagram.com/wan_xzyaa" target="_blank" rel="noopener">Instagram</a>
          <a href="https://t.me/wanda_ginting" target="_blank" rel="noopener">Telegram</a>
        </div>
      </div>

      <div style="flex:1"></div>
      <div class="muted" style="margin-top:12px">Thanks you for using it!</div>
    </aside>

    <!-- Overlay for closing sidebar -->
    <div id="overlay" class="overlay" aria-hidden="true"></div>

    <!-- Chat Area -->
    <section class="chat-area" style="flex:1;">
      <div id="chatWindow" class="chat-window" role="log" aria-live="polite"></div>

      <div class="composer-wrap">
        <form id="composer" class="composer" autocomplete="off">
          <button id="attachBtn" type="button" class="attach-btn" title="Lampirkan">üìé</button>

          <div id="attachPopup" class="attach-popup" aria-hidden="true">
            <div class="attach-option" id="pickImage"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M5 3h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm7 4a3 3 0 1 0 .001 6.001A3 3 0 0 0 12 7zm-6 8l3.5-4.5 2.5 3 1.5-2 4.5 6H6z"/></svg><div>Foto</div></div>

            <div class="attach-option" id="pickDoc"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M6 2h7l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zM13 3.5V9h5.5"/></svg><div>Dokumen</div></div>

            <div class="attach-option" id="cameraBtn"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm7-1h-2.3l-1-1.2A1 1 0 0 0 15.9 4H8.1a1 1 0 0 0-.8.3L6.4 5.8H4a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2z"/></svg><div>Kamera</div></div>
          </div>

          <input id="fileInput" type="file" accept="image/*" style="display:none" />
          <input id="docInput" type="file" accept=".pdf,.doc,.docx,.txt" style="display:none" />

          <textarea id="input" placeholder="Tulis pesan..." aria-label="Pesan"></textarea>

          <button id="sendBtn" type="submit" class="send-btn" aria-label="Kirim">
            <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
          </button>
        </form>
      </div>
    </section>
  </div>

  <div class="wm">¬© Wanz Official</div>

<!-- camera modal template -->
<div id="cameraModal" class="popup" aria-hidden="true">
  <div class="popup-card" role="dialog" aria-modal="true">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div style="font-weight:700">Ambil Foto</div>
      <button id="cameraClose" class="btn" style="padding:6px 10px;margin-left:8px">Batal</button>
    </div>
    <div id="cameraArea" style="margin-top:12px"></div>
  </div>
</div>

<script>
(() => {
  // endpoints
  const API_CHAT = '/api/chat';
  const API_REPORT = '/api/report';
  const API_STATUS = '/api/status';

  // UI nodes
  const menuBtn = document.getElementById('menuBtn');
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');
  const clearHistoryBtn = document.getElementById('clearHistory');
  const reportBtn = document.getElementById('reportBtn');
  const customPromptEl = document.getElementById('customPrompt');
  const roleSelect = document.getElementById('roleSelect');

  const chatWindow = document.getElementById('chatWindow');
  const composer = document.getElementById('composer');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');

  const attachBtn = document.getElementById('attachBtn');
  const attachPopup = document.getElementById('attachPopup');
  const pickImageBtn = document.getElementById('pickImage');
  const pickDocBtn = document.getElementById('pickDoc');
  const cameraBtn = document.getElementById('cameraBtn');
  const fileInput = document.getElementById('fileInput');
  const docInput = document.getElementById('docInput');

  const notifWrap = document.getElementById('notifWrap');

  const cameraModal = document.getElementById('cameraModal');
  const cameraArea = document.getElementById('cameraArea');
  const cameraClose = document.getElementById('cameraClose');

  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');

  // state
  let userId = localStorage.getItem('xcv_user_id');
  if (!userId) { userId = 'web-' + (crypto && crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36)); localStorage.setItem('xcv_user_id', userId); }
  let history = JSON.parse(localStorage.getItem('xcv_hist_' + userId) || '[]');

  // helper: escape HTML
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[c]); }

  // small notif helper (top-center), type: 'success'|'warn'|'info'
  function showNotif(text, type='info', timeout=3000){
    const el = document.createElement('div'); el.className = 'notif ' + (type === 'success' ? 'success' : (type === 'warn' ? 'warn' : ''));
    el.textContent = text;
    notifWrap.appendChild(el);
    // animate in
    requestAnimationFrame(()=> el.classList.add('show'));
    setTimeout(()=> {
      el.classList.remove('show');
      setTimeout(()=> { try{ notifWrap.removeChild(el); }catch{} }, 320);
    }, timeout);
  }

  // render message
  function addMessage(role, text, attachments){
    const container = document.createElement('div');
    container.className = 'msg ' + (role === 'user' ? 'user' : 'ai');

    const bubble = document.createElement('div');
    bubble.innerHTML = `<div class="meta">${role === 'user' ? 'Anda' : 'XCViienzo'}</div><div class="body">${escapeHtml(text||'')}</div>`;

    container.appendChild(bubble);

    if (attachments && attachments.length){
      const imgs = document.createElement('div'); imgs.className = 'imgs';
      attachments.forEach(src => {
        const im = document.createElement('img'); im.src = src; im.alt = 'lampiran'; im.style.maxWidth='160px'; im.style.borderRadius='8px'; im.style.marginTop='8px';
        imgs.appendChild(im);
      });
      bubble.appendChild(imgs);
    }

    chatWindow.appendChild(container);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  // render all
  function renderAll(){
    chatWindow.innerHTML = '';
    if (!history.length){
      const p = document.createElement('div'); p.className = 'empty-hint'; p.textContent = 'Halo! Tanyakan sesuatu ke XCViienzo ‚Äî mulai mengetik di bawah.'; chatWindow.appendChild(p); return;
    }
    history.forEach(m => addMessage(m.role, m.content, m.attachments || []));
  }

  function saveHistory(){ try{ localStorage.setItem('xcv_hist_' + userId, JSON.stringify(history)); }catch(e){} }

  // sidebar toggle (burger)
  menuBtn.addEventListener('click', ()=>{
    const open = sidebar.classList.contains('show');
    if (!open){
      sidebar.classList.add('show'); overlay.classList.add('show'); overlay.style.display = 'block'; overlay.setAttribute('aria-hidden','false'); sidebar.setAttribute('aria-hidden','false');
    } else {
      sidebar.classList.remove('show'); overlay.classList.remove('show'); setTimeout(()=>overlay.style.display='none',240); overlay.setAttribute('aria-hidden','true'); sidebar.setAttribute('aria-hidden','true');
    }
  });
  overlay.addEventListener('click', ()=>{ sidebar.classList.remove('show'); overlay.classList.remove('show'); setTimeout(()=>overlay.style.display='none',240); });

  // clear history (ke fungsi lama)
  clearHistoryBtn.addEventListener('click', ()=> {
    history = []; saveHistory(); renderAll();
    showNotif('Riwayat percakapan dihapus.', 'warn', 2200);
  });

  // report: open styled modal-like popup (but we'll reuse central modal pattern)
  reportBtn.addEventListener('click', showReport);

  function showReport(){
    // build small card in center (modal style) but use custom popup element with animation
    const modal = document.createElement('div'); modal.className = 'popup show';
    const card = document.createElement('div'); card.className = 'popup-card';
    card.innerHTML = `<h3 style="margin:0 0 8px 0">Laporkan Masalah</h3>
      <p style="margin:0 0 12px;color:var(--muted)">Kirim laporan singkat, tim dev akan cek.</p>
      <input id="r_title" placeholder="Judul singkat" style="width:100%;padding:8px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)"/>
      <textarea id="r_body" placeholder="Jelaskan masalah..." rows="6" style="width:100%;margin-top:8px;padding:8px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)"></textarea>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="r_cancel" class="btn" style="padding:8px 12px">Batal</button>
        <button id="r_send" class="btn" style="padding:8px 12px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#071018">Kirim</button>
      </div>`;
    modal.appendChild(card);
    document.body.appendChild(modal);

    // handlers
    modal.addEventListener('click', (e) => { if (e.target === modal) close(); });
    function close(){ try{ document.body.removeChild(modal); }catch{} }

    document.getElementById('r_cancel').addEventListener('click', close);
    document.getElementById('r_send').addEventListener('click', async ()=>{
      const t = document.getElementById('r_title').value.trim();
      const b = document.getElementById('r_body').value.trim();
      if (!t && !b) { showNotif('Isi judul atau isi laporan terlebih dulu.', 'warn'); return; }
      document.getElementById('r_send').disabled = true; document.getElementById('r_send').textContent = 'Mengirim...';
      try {
        const r = await fetch(API_REPORT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title: t, body: b, userId }) });
        const data = await r.json().catch(()=>null);
        if (!r.ok) throw new Error((data && data.error) ? data.error : ('HTTP ' + r.status));
        showNotif('‚úÖ Laporan terkirim. Terima kasih.', 'success', 3200);
        close();
      } catch (err) {
        showNotif('‚ö†Ô∏è Gagal kirim laporan: ' + (err && err.message ? err.message : err), 'warn', 4000);
        document.getElementById('r_send').disabled = false; document.getElementById('r_send').textContent = 'Kirim';
      }
    });
  }

  // attach popup controls (animated)
  attachBtn.addEventListener('click', (e)=>{ e.stopPropagation(); attachPopup.classList.toggle('show'); attachPopup.setAttribute('aria-hidden', !attachPopup.classList.contains('show')); });
  document.addEventListener('click', (e)=>{ if (!attachPopup.contains(e.target) && e.target !== attachBtn) { attachPopup.classList.remove('show'); attachPopup.setAttribute('aria-hidden','true'); } });

  pickImageBtn.addEventListener('click', ()=> fileInput.click());
  pickDocBtn.addEventListener('click', ()=> docInput.click());

  fileInput.addEventListener('change', async (ev)=> {
    const f = ev.target.files && ev.target.files[0]; if (!f) return;
    try {
      const data = await readFileAsDataURL(f);
      inputEl.value = `(gambar terlampir) ${f.name}`; inputEl.dataset.attached = JSON.stringify({ type:'image', data, name: f.name });
      showNotif('Gambar siap dikirim', 'success');
    } catch(err){ showNotif('Gagal baca file: ' + (err && err.message ? err.message : err), 'warn'); }
  });
  docInput.addEventListener('change', async (ev)=> {
    const f = ev.target.files && ev.target.files[0]; if (!f) return;
    try {
      const data = await readFileAsDataURL(f);
      inputEl.value = `(dokumen terlampir) ${f.name}`; inputEl.dataset.attached = JSON.stringify({ type:'document', data, name: f.name });
      showNotif('Dokumen siap dikirim', 'success');
    } catch(err){ showNotif('Gagal baca file: ' + (err && err.message ? err.message : err), 'warn'); }
  });

  // camera
  cameraBtn.addEventListener('click', async (e)=> {
    e.stopPropagation();
    attachPopup.classList.remove('show');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      cameraArea.innerHTML = '';
      const video = document.createElement('video'); video.autoplay=true; video.muted=true; video.playsInline=true; video.srcObject=stream; video.style.width='100%'; video.style.borderRadius='10px';
      const snap = document.createElement('button'); snap.className='btn'; snap.textContent='Ambil Foto'; snap.style.marginTop='10px';
      const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Batal'; cancel.style.marginLeft='8px';
      cameraArea.appendChild(video); cameraArea.appendChild(snap); cameraArea.appendChild(cancel);
      document.body.appendChild(cameraModal); cameraModal.classList.add('show');

      snap.addEventListener('click', ()=> {
        const canvas = document.createElement('canvas'); canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video,0,0);
        const data = canvas.toDataURL('image/png');
        inputEl.value='(foto kamera)'; inputEl.dataset.attached = JSON.stringify({ type:'image', data, name:'camera.png' });
        stream.getTracks().forEach(t=>t.stop());
        closeCamera();
        showNotif('Foto siap dikirim', 'success');
      });
      cancel.addEventListener('click', ()=> { stream.getTracks().forEach(t=>t.stop()); closeCamera(); });

      cameraClose.addEventListener('click', ()=>{ stream.getTracks().forEach(t=>t.stop()); closeCamera(); }, { once:true });
    } catch(err){
      showNotif('Gagal akses kamera: ' + (err && err.message ? err.message : err), 'warn');
    }
  });

  function closeCamera(){ try{ cameraModal.classList.remove('show'); if (cameraModal.parentNode) document.body.removeChild(cameraModal); }catch{} }

  // composer submit ‚Äî FIXED: parse JSON reply
  composer.addEventListener('submit', async (ev)=> {
    ev.preventDefault();
    const text = (inputEl.value || '').trim();
    const attached = inputEl.dataset.attached ? JSON.parse(inputEl.dataset.attached) : null;
    if (!text && !attached) return;

    // push user message
    const userMsg = { role:'user', content: text || (attached ? ('(lampiran: ' + (attached.name || 'file') + ')') : ''), attachments: attached && attached.type === 'image' ? [attached.data] : [] };
    history.push(userMsg); saveHistory(); renderAll();
    inputEl.value = ''; delete inputEl.dataset.attached;
    attachPopup.classList.remove('show');

    // show loading indicator (bot typing animasi)
const loadingEl = document.createElement('div');
loadingEl.className = 'msg ai';
loadingEl.innerHTML = `<div class="body"><div class="typing-dots">
  <span>.</span><span>.</span><span>.</span>
</div></div>`;
chatWindow.appendChild(loadingEl);
chatWindow.scrollTop = chatWindow.scrollHeight;

    // prepare payload: last 12 messages
    const limited = history.slice(-12).map(m => ({ role: m.role, content: typeof m.content === 'string' ? m.content : '' }));

    try {
      const res = await fetch(API_CHAT, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ userId, messages: limited, prompt: customPromptEl.value || null, role: roleSelect.value || null })
      });

      // parse JSON response (API returns { reply: "..." })
      const data = await res.json().catch(()=>null);
      try{ loadingEl.remove(); }catch(e){}

      if (!res.ok) {
        const errMsg = (data && data.error) ? data.error : ('HTTP ' + (res.status || '??'));
        history.push({ role:'assistant', content: '‚ö†Ô∏è Gagal: ' + errMsg }); saveHistory(); renderAll(); showNotif('‚ö†Ô∏è Gagal terima balasan', 'warn', 2600);
        updateStatus(false);
        return;
      }

      const content = (data && (data.reply || data.responseText)) ? (data.reply || data.responseText) : '(tidak ada balasan)';

// buang loadingEl (titik animasi)
try { loadingEl.remove(); } catch(e){}

// buat bubble kosong untuk efek ketikan
const msgEl = document.createElement('div');
msgEl.className = 'msg ai';
const bodyEl = document.createElement('div');
bodyEl.className = 'body';
msgEl.appendChild(bodyEl);
chatWindow.appendChild(msgEl);
chatWindow.scrollTop = chatWindow.scrollHeight;

// efek ketikan cepat
let i = 0;
const speed = 20; // ms per karakter
const typingInterval = setInterval(() => {
  bodyEl.textContent = content.slice(0, i);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  i++;
  if (i > content.length) {
    clearInterval(typingInterval);
    // simpan ke history setelah selesai
    history.push({ role:'assistant', content });
    saveHistory();
  }
}, speed);

    } catch (err) {
      try{ loadingEl.remove(); }catch(e){}
      const msg = '‚ö†Ô∏è Koneksi gagal: ' + (err && err.message ? err.message : err);
      history.push({ role:'assistant', content: msg }); saveHistory(); renderAll(); showNotif(msg, 'warn', 4000);
      updateStatus(false);
    }
  });

  // status ping
  async function checkStatus(){
    try {
      const r = await fetch(API_STATUS, { method:'GET' , cache:'no-store' });
      const data = await r.json().catch(()=>null);
      if (r.ok && data && (data.status === 'ok' || data.ok)) { updateStatus(true); return; }
      if (r.ok) { updateStatus(true); return; }
      updateStatus(false);
    } catch(e) { updateStatus(false); }
  }
  function updateStatus(online){
    if (online){ statusDot.style.color = '#33cc66'; statusText.textContent = 'Online'; }
    else { statusDot.style.color = '#ff6b6b'; statusText.textContent = 'Offline'; }
  }
  checkStatus(); setInterval(checkStatus, 8000);

  // utilities
  function readFileAsDataURL(file){ return new Promise((res, rej)=>{ const r = new FileReader(); r.onload = ()=> res(r.result); r.onerror = ()=> rej(new Error('Gagal membaca file')); r.readAsDataURL(file); }); }

  // initial render
  renderAll();

  // keyboard: Enter to send, Shift+Enter newline
  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  // close sidebar with Esc
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') { sidebar.classList.remove('show'); overlay.classList.remove('show'); setTimeout(()=>overlay.style.display='none',240); } });

})();
</script>
</body>
</html>